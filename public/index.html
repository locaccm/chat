<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
      }
      .container {
        display: flex;
        width: 100%;
        height: 100%;
      }
      .sidebar {
        width: 25%;
        background: #f4f4f4;
        padding: 10px;
        overflow-y: auto;
      }
      .chat {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .messages {
        flex-grow: 1;
        padding: 10px;
        overflow-y: auto;
        border-bottom: 1px solid #ddd;
      }
      .input-container {
        padding: 10px;
        display: flex;
        gap: 10px;
      }
      input {
        flex-grow: 1;
        padding: 8px;
      }
      button {
        padding: 8px 15px;
        cursor: pointer;
      }
      .contact {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
      }
      .contact:hover {
        background: #ddd;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      let currentUser = null;
      let contacts = [];

      function loadContacts() {
        fetch("/users") // Fetch all users
          .then((response) => response.json())
          .then((users) => {
            // Use loggedInUser instead of currentUser
            if (!loggedInUser) return;

            // Get only linked users
            const linkedUsers = users.filter((u) =>
              loggedInUser.linkedTo.includes(u.id)
            );

            const contactsDiv = document.getElementById("contacts");
            contactsDiv.innerHTML = "";
            linkedUsers.forEach((user) => {
              const div = document.createElement("div");
              div.className = "contact";
              div.innerText = user.name + " (" + user.type + ")";
              div.onclick = () => selectUser(user);
              contactsDiv.appendChild(div);
            });
          });
      }

      function selectUser(user) {
        currentUser = user;
        document.getElementById("chat-title").innerText =
          "Chat with " + user.name;
        document.getElementById("messages").innerHTML = ""; // Clear chat
      }

      function sendMessage() {
        const message = document.getElementById("message").value;
        if (!currentUser) {
          alert("Select a user first!");
          return;
        }

        // Send the message with both sender and receiver info
        socket.emit("chat message", {
          to: currentUser.id,
          message,
          from: loggedInUser.id,
        });

        document.getElementById("message").value = "";
      }

      socket.on("chat message", (data) => {
        const { message, from } = data;

        const messages = document.getElementById("messages");
        const item = document.createElement("div");
        item.textContent = `${from}: ${message}`;
        messages.appendChild(item);
      });

      window.onload = function () {
        fetch("/users")
          .then((response) => response.json())
          .then((users) => {
            const userId = prompt("Enter your user ID (1-5)");
            loggedInUser = users.find((user) => user.id == userId);
            if (!loggedInUser) {
              alert("Invalid user ID!");
              return;
            }

            // Register this user with the server
            socket.emit("register user", loggedInUser.id);

            alert(`You are logged in as ${loggedInUser.name}`);

            // Now we can safely load contacts
            loadContacts();
          });
      };
    </script>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h3>Contacts</h3>
        <div id="contacts"></div>
      </div>
      <div class="chat">
        <h2 id="chat-title">Select a user</h2>
        <div id="messages" class="messages"></div>
        <div class="input-container">
          <input id="message" type="text" placeholder="Type a message..." />
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </body>
</html>
